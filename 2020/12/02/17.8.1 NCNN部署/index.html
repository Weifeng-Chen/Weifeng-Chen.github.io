<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>17.8.1 NCNN部署 | 伟峰的个人网站</title><meta name="keywords" content="深度学习500问"><meta name="author" content="Weifeng"><meta name="copyright" content="Weifeng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="转自：github库### 17.8.1 NCNN部署  1.在电脑端使用ncnn实现分类(alexnet) s1，安装g++，cmake，protobuf，opencv s2，对源码进行编译 123456git clone https:&#x2F;&#x2F;github.com&#x2F;Tencent&#x2F;ncnn$ cd &lt;ncnn-root-dir&gt;$ mkdir -p build$ cd build$ cm">
<meta property="og:type" content="article">
<meta property="og:title" content="17.8.1 NCNN部署">
<meta property="og:url" content="http://weifeng-chen.github.io/2020/12/02/17.8.1%20NCNN%E9%83%A8%E7%BD%B2/index.html">
<meta property="og:site_name" content="伟峰的个人网站">
<meta property="og:description" content="转自：github库### 17.8.1 NCNN部署  1.在电脑端使用ncnn实现分类(alexnet) s1，安装g++，cmake，protobuf，opencv s2，对源码进行编译 123456git clone https:&#x2F;&#x2F;github.com&#x2F;Tencent&#x2F;ncnn$ cd &lt;ncnn-root-dir&gt;$ mkdir -p build$ cd build$ cm">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-12-01T18:28:42.633Z">
<meta property="article:modified_time" content="2020-12-01T18:24:16.171Z">
<meta property="article:author" content="Weifeng">
<meta property="article:tag" content="深度学习500问">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/iron_icon.png"><link rel="canonical" href="http://weifeng-chen.github.io/2020/12/02/17.8.1%20NCNN%E9%83%A8%E7%BD%B2/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-12-02 02:24:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = '2'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/myavatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">22</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于我</span></a></div></div></div></div><div id="body-wrap"><header class="no-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">伟峰的个人网站</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于我</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">17.8.1 NCNN部署</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-12-01T18:28:42.633Z" title="发表于 2020-12-02 02:28:42">2020-12-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-12-01T18:24:16.171Z" title="更新于 2020-12-02 02:24:16">2020-12-02</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>23分钟</span></span></div></div></div><article class="post-content" id="article-container"><p>转自：<a target="_blank" rel="noopener" href="https://github.com/scutan90/DeepLearning-500-questions">github库</a>### 17.8.1 NCNN部署</p>
<h5 id="1在电脑端使用ncnn实现分类alexnet"><a class="markdownIt-Anchor" href="#1在电脑端使用ncnn实现分类alexnet"></a> 1.在电脑端使用ncnn实现分类(alexnet)</h5>
<p>s1，安装g++，cmake，protobuf，opencv</p>
<p>s2，对源码进行编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/Tencent/ncnn</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> &lt;ncnn-root-dir&gt;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cmake ..</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make -j4</span></span><br></pre></td></tr></table></figure>
<p>s3，准备caffe模型文件(alexnet)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">deploy.prototxt  </span><br><span class="line">snapshot_10000.caffemodel  </span><br></pre></td></tr></table></figure>
<p>alexnet   <a target="_blank" rel="noopener" href="https://github.com/BVLC/caffe/tree/master/models/bvlc_alexnet">deploy.prototxt</a>， <a target="_blank" rel="noopener" href="http://dl.caffe.berkeleyvision.org/bvlc_alexnet.caffemodel">caffemodel</a></p>
<p>s4，使用ncnn转换工具将旧caffe版本的prototxt和caffemodel转新版本</p>
<p>将旧caffe版本的prototxt和caffemodel存放在caffe/build/tools目录下，执行如下命令完成转换</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./upgrade_net_proto_text [old prototxt] [new prototxt]</span><br><span class="line">./upgrade_net_proto_binary [old caffemodel] [new caffemodel]</span><br></pre></td></tr></table></figure>
<p>s5，将deploy.prototxt中输入层替换成input层(如果只读取一张图片将dim设置为1)</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">layer &#123;</span><br><span class="line">  name: <span class="string">&quot;data&quot;</span></span><br><span class="line">  type: <span class="string">&quot;Input&quot;</span></span><br><span class="line">  top: <span class="string">&quot;data&quot;</span></span><br><span class="line">  input_param &#123; shape: &#123; dim: <span class="number">1</span> dim: <span class="number">3</span> dim: <span class="number">227</span> dim: <span class="number">227</span> &#125; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>s6，使用caffe2ncnn工具将caffe model转成ncnn model</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./caffe2ncnn deploy.prototxt bvlc_alexnet.caffemodel alexnet.param alexnet.bin</span><br></pre></td></tr></table></figure>
<p>在ncnn/build/tools目录下生成param和bin文件。</p>
<p>s7，对模型参数进行加密</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ncnn2mem alexnet.param alexnet.bin alexnet.id.h alexnet.mem.h</span><br></pre></td></tr></table></figure>
<p>在ncnn/build/tools目录下生成.param、.bin和.h文件。</p>
<p>alexnet.param    网络的模型参数</p>
<p>alexnet.bin   网络的权重</p>
<p>alexnet.id.h   在预测图片的时候使用到</p>
<p>s8，编写pc端代码(参考https://blog.csdn.net/qq_36982160/article/details/79929869)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&quot;gesture.id.h&quot;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;net.h&quot;</span> </span></span><br><span class="line"><span class="comment">//使用ncnn，传入的参数第一个是你需要预测的数据，第二个参数是各个类别的得分vector，注意传入的是地址，这样才能在这个函数中改变其值 </span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">detect_squeezenet</span><span class="params">( <span class="keyword">float</span> *data, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">float</span>&gt;&amp; cls_scores)</span> </span>&#123; </span><br><span class="line">	<span class="comment">//实例化ncnn：Net，注意include &quot;net.h&quot;，不要在意这时候因为找不到net.h文件而include&lt;net.h&gt;报错，后文会介绍正确的打开方式 </span></span><br><span class="line">	ncnn::Net squeezenet; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">//加载二进制文件，也是照写，后面会介绍对应文件应该放的正确位置 </span></span><br><span class="line">	<span class="keyword">int</span> a=squeezenet.load_param(<span class="string">&quot;demo.param&quot;</span>); </span><br><span class="line">	<span class="keyword">int</span> b=squeezenet.load_param_bin(<span class="string">&quot;demo.bin&quot;</span>); </span><br><span class="line"></span><br><span class="line">	<span class="comment">//实例化Mat，前三个参数是维度，第四个参数是传入的data，维度的设置根据你自己的数据进行设置，顺序是w、h、c </span></span><br><span class="line">	ncnn::Mat in = ncnn::Mat(<span class="number">550</span>, <span class="number">8</span>, <span class="number">2</span>, data); </span><br><span class="line">	</span><br><span class="line">	<span class="comment">//实例化Extractor </span></span><br><span class="line">	ncnn::Extractor ex = squeezenet.create_extractor(); </span><br><span class="line">	ex.set_light_mode(<span class="literal">true</span>); </span><br><span class="line">	<span class="comment">//注意把&quot;data&quot;换成你deploy中的数据层名字 </span></span><br><span class="line">	<span class="keyword">int</span> d= ex.input(<span class="string">&quot;data&quot;</span>, in); </span><br><span class="line">	</span><br><span class="line">	ncnn::Mat out; </span><br><span class="line">	<span class="comment">//这里是真正的终点，不多说了，只能仰天膜拜nihui大牛，重点是将prob换成你deploy中最后一层的名字 </span></span><br><span class="line">	<span class="keyword">int</span> c=ex.extract(<span class="string">&quot;prob&quot;</span>, out); </span><br><span class="line">	</span><br><span class="line">	<span class="comment">//将out中的值转化为我们的cls_scores，这样就可以返回不同类别的得分了 </span></span><br><span class="line">	cls_scores.resize(out.w); </span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;out.w; j++) &#123; </span><br><span class="line">		cls_scores[j] = out[j]; </span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123; </span><br><span class="line">	<span class="comment">//注意，这里的argv是之后从终端输入的参数，我这里是数据源的路径,因为我是从两个文件中生成一个总的数据，所以用了argv[1]和argv[2]，你也可以自己根据需求改变 </span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* imagepath1 = argv[<span class="number">1</span>]; </span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* imagepath2=argv[<span class="number">2</span>]; </span><br><span class="line">	</span><br><span class="line">	FILE *fopeni=<span class="literal">NULL</span>; </span><br><span class="line">	FILE *fopenq=<span class="literal">NULL</span>; </span><br><span class="line">	</span><br><span class="line">	fopeni=fopen(imagepath1,<span class="string">&quot;r&quot;</span>); </span><br><span class="line">	fopenq=fopen(imagepath2,<span class="string">&quot;r&quot;</span>); </span><br><span class="line">	</span><br><span class="line">	<span class="comment">//这是我的数据，i和q相当于图片的两个通道 </span></span><br><span class="line">	<span class="keyword">float</span> i[<span class="number">4400</span>]; </span><br><span class="line">	<span class="keyword">float</span> q[<span class="number">4400</span>]; </span><br><span class="line">	<span class="keyword">float</span> data[<span class="number">8800</span>]; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> count=<span class="number">4400</span>; </span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; count; ++j) &#123; </span><br><span class="line">		<span class="built_in">fscanf</span>(fopeni,<span class="string">&quot;%f&quot;</span>,&amp;i[j]); </span><br><span class="line">		<span class="built_in">fscanf</span>(fopenq,<span class="string">&quot;%f&quot;</span>,&amp;q[j]); </span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">//这是将iq（相当于图片的两个通道的数据）转化为一个一维向量，需要特别注意的是数据维度的顺序 </span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">8800</span>; ++j) &#123; </span><br><span class="line">		<span class="keyword">if</span> (j&lt;<span class="number">4400</span>) &#123; </span><br><span class="line">			data[j]=i[j]; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123; </span><br><span class="line">			data[j]=q[j<span class="number">-4400</span>]; </span><br><span class="line">		&#125; </span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">char</span> a[<span class="number">13</span>]=&#123;<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;G&#x27;</span>,<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;I&#x27;</span>,<span class="string">&#x27;J&#x27;</span>,<span class="string">&#x27;K&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;O&#x27;</span>&#125;; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">//注意，这里是调用ncnn的代码 </span></span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">float</span>&gt; cls_scores;  <span class="comment">//用来存储最终各类别的得分 </span></span><br><span class="line">	<span class="comment">//这个函数的实现在上面，快去看 </span></span><br><span class="line">	detect_squeezenet(data, cls_scores); </span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cls_scores.size(); ++i) &#123; </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%c : %f\n&quot;</span>, a[i],cls_scores[i]); </span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码是最简单的ncnn使用场景，可以根据自己需求加入代码。</p>
<p>s9，编译代码</p>
<p>(1) 编写CMakeLists.txt</p>
<p>在CMakeLists.txt增加如下两行代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add_executable(demo demo.cpp)</span><br><span class="line">target_link_libraries(demo ncnn)</span><br></pre></td></tr></table></figure>
<p>CMakeLists.txt如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">find_package(OpenCV QUIET COMPONENTS core highgui imgproc imgcodecs) </span><br><span class="line">if(NOT OpenCV_FOUND) </span><br><span class="line">	find_package(OpenCV REQUIRED COMPONENTS core highgui imgproc) </span><br><span class="line">endif() </span><br><span class="line"></span><br><span class="line">include_directories($&#123;CMAKE_CURRENT_SOURCE_DIR&#125;&#x2F;..&#x2F;src) </span><br><span class="line">include_directories($&#123;CMAKE_CURRENT_BINARY_DIR&#125;&#x2F;..&#x2F;src) </span><br><span class="line"></span><br><span class="line">add_executable(squeezenet squeezenet.cpp) </span><br><span class="line"></span><br><span class="line">target_link_libraries(squeezenet ncnn $&#123;OpenCV_LIBS&#125;) </span><br><span class="line"></span><br><span class="line">add_executable(fasterrcnn fasterrcnn.cpp) </span><br><span class="line">target_link_libraries(fasterrcnn ncnn $&#123;OpenCV_LIBS&#125;) </span><br><span class="line"></span><br><span class="line">add_executable(demo demo.cpp) </span><br><span class="line">target_link_libraries(demo ncnn) </span><br><span class="line"></span><br><span class="line">add_subdirectory(ssd)</span><br></pre></td></tr></table></figure>
<p>(2) 在ncnn根目录下CMakeLists.txt中编译examples语句的注释去掉</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">##############################################</span><br><span class="line"></span><br><span class="line"># add_subdirectory(examples)</span><br><span class="line"># add_subdirectory(benchmark)</span><br><span class="line">add_subdirectory(src)</span><br><span class="line">if(NOT ANDROID AND NOT IOS)</span><br><span class="line">add_subdirectory(tools)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
<p>(3)ncnn/build目录下进行编译，生成demo可执行文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>
<p>s10，执行</p>
<p>将生成的.param和.bin文件复制到ncnn/build/examples目录下，然后终端cd到ncnn/build/examples，执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;demo data_path1 data_path2</span><br></pre></td></tr></table></figure>
<h5 id="2-win-x64-visual-studio-community-2017"><a class="markdownIt-Anchor" href="#2-win-x64-visual-studio-community-2017"></a> 2. Win x64 (Visual Studio Community 2017)</h5>
<p>s1，安装Visual Studio Community 2017</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">download Visual Studio Community 2017 from https:&#x2F;&#x2F;visualstudio.microsoft.com&#x2F;vs&#x2F;community&#x2F;</span><br><span class="line">install it</span><br><span class="line">Start → Programs → Visual Studio 2017 → Visual Studio Tools → x64 Native Tools Command Prompt for VS 2017</span><br></pre></td></tr></table></figure>
<p>s2，编译protobuf</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">download protobuf<span class="literal">-3</span>.<span class="number">4.0</span> from https://github.com/google/protobuf/archive/v3.<span class="number">4.0</span>.zip</span><br><span class="line">&gt; <span class="built_in">cd</span> &lt;protobuf<span class="literal">-root</span><span class="literal">-dir</span>&gt;</span><br><span class="line">&gt; mkdir build<span class="literal">-vs2017</span></span><br><span class="line">&gt; <span class="built_in">cd</span> build<span class="literal">-vs2017</span></span><br><span class="line">&gt; cmake <span class="literal">-G</span><span class="string">&quot;NMake Makefiles&quot;</span> <span class="literal">-DCMAKE_BUILD_TYPE</span>=Release <span class="literal">-DCMAKE_INSTALL_PREFIX</span>=%<span class="built_in">cd</span>%/install <span class="literal">-Dprotobuf_BUILD_TESTS</span>=OFF <span class="literal">-Dprotobuf_MSVC_STATIC_RUNTIME</span>=OFF ../cmake</span><br><span class="line">&gt; nmake</span><br><span class="line">&gt; nmake install</span><br></pre></td></tr></table></figure>
<p>s3，编译ncnn库</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">cd</span> &lt;ncnn<span class="literal">-root</span><span class="literal">-dir</span>&gt;</span><br><span class="line">&gt; mkdir <span class="literal">-p</span> build<span class="literal">-vs2017</span></span><br><span class="line">&gt; <span class="built_in">cd</span> build<span class="literal">-vs2017</span></span><br><span class="line">&gt; cmake <span class="literal">-G</span><span class="string">&quot;NMake Makefiles&quot;</span> <span class="literal">-DCMAKE_BUILD_TYPE</span>=Release <span class="literal">-DCMAKE_INSTALL_PREFIX</span>=%<span class="built_in">cd</span>%/install <span class="literal">-DProtobuf_INCLUDE_DIR</span>=&lt;protobuf<span class="literal">-root</span><span class="literal">-dir</span>&gt;/build<span class="literal">-vs2017</span>/install/include <span class="literal">-DProtobuf_LIBRARIES</span>=&lt;protobuf<span class="literal">-root</span><span class="literal">-dir</span>&gt;/build<span class="literal">-vs2017</span>/install/lib/libprotobuf.lib <span class="literal">-DProtobuf_PROTOC_EXECUTABLE</span>=&lt;protobuf<span class="literal">-root</span><span class="literal">-dir</span>&gt;/build<span class="literal">-vs2017</span>/install/bin/protoc.exe ..</span><br><span class="line">&gt; nmake</span><br><span class="line">&gt; nmake install</span><br><span class="line"></span><br><span class="line">pick build<span class="literal">-vs2017</span>/install folder <span class="keyword">for</span> further usage</span><br></pre></td></tr></table></figure>
<h5 id="3-android端使用ncnn"><a class="markdownIt-Anchor" href="#3-android端使用ncnn"></a> 3. Android端使用ncnn</h5>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33200967/article/details/82421089">https://blog.csdn.net/qq_33200967/article/details/82421089</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36982160/article/details/79931741">https://blog.csdn.net/qq_36982160/article/details/79931741</a></p>
<p>s1，使用Android Studio安装ndk</p>
<p>1）打开Android Studio，依次点击File-&gt;Settings-&gt;Appearance&amp;Behavior-&gt;System Settings-&gt;Android SDK-&gt;SDK Tool，选中NDK，点击apply自动下载安装(如果安装成功会在SDK目录下生成ndk-bundle文件夹)；</p>
<p>2）配置ndk的环境变量</p>
<ul>
<li>
<p>打开profile</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/profile</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在profile文件末尾添加ndk路径</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export NDK_HOME=sdkroot/ndk-bundle</span><br><span class="line">PATH=$NDK_HOME:$PATH</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>保存退出，使用source命令使环境变量生效</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>验证ndk是否配置成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ndk-build -v</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>s2，编译ncnn sdk</p>
<p>通过如下命令编译ncnn sdk，会在ncnn/build-android下生成install文件夹，其中包括：include(调用ncnn所需的头文件)和lib(编译得到的ncnn库libncnn.a)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir build-android</span><br><span class="line">cd build-android</span><br><span class="line">cmake -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK/build/cmake/android.toolchain.cmake \</span><br><span class="line">    -DANDROID_ABI=&quot;armeabi-v7a&quot; -DANDROID_ARM_NEON=ON \</span><br><span class="line">    -DANDROID_PLATFORM=android-14 ..</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">make package</span><br></pre></td></tr></table></figure>
<p>参数设置请参考：<a target="_blank" rel="noopener" href="https://github.com/Tencent/ncnn/wiki/cmake-%E6%89%93%E5%8C%85-android-sdk">https://github.com/Tencent/ncnn/wiki/cmake-打包-android-sdk</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ANDROID_ABI 是架构名字，&quot;armeabi-v7a&quot; 支持绝大部分手机硬件</span><br><span class="line">ANDROID_ARM_NEON 是否使用 NEON 指令集，设为 ON 支持绝大部分手机硬件</span><br><span class="line">ANDROID_PLATFORM 指定最低系统版本，&quot;android-14&quot; 就是 android-4.0</span><br></pre></td></tr></table></figure>
<p>s3，对源码进行编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/Tencent/ncnn</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> &lt;ncnn-root-dir&gt;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cmake ..</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make -j4</span></span><br></pre></td></tr></table></figure>
<p>s4，准备caffe模型文件(alexnet)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">deploy.prototxt  </span><br><span class="line">snapshot_10000.caffemodel  </span><br></pre></td></tr></table></figure>
<p>alexnet   <a target="_blank" rel="noopener" href="https://github.com/BVLC/caffe/tree/master/models/bvlc_alexnet">deploy.prototxt</a>， <a target="_blank" rel="noopener" href="http://dl.caffe.berkeleyvision.org/bvlc_alexnet.caffemodel">caffemodel</a></p>
<p>s5，使用ncnn转换工具将旧caffe版本的prototxt和caffemodel转新版本</p>
<p>将旧caffe版本的prototxt和caffemodel存放在caffe/build/tools目录下，执行如下命令完成转换</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./upgrade_net_proto_text [old prototxt] [new prototxt]</span><br><span class="line">./upgrade_net_proto_binary [old caffemodel] [new caffemodel]</span><br></pre></td></tr></table></figure>
<p>s6，将deploy.prototxt中输入层替换成input层(如果只读取一张图片将dim设置为1)</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">layer &#123;</span><br><span class="line">  name: <span class="string">&quot;data&quot;</span></span><br><span class="line">  type: <span class="string">&quot;Input&quot;</span></span><br><span class="line">  top: <span class="string">&quot;data&quot;</span></span><br><span class="line">  input_param &#123; shape: &#123; dim: <span class="number">1</span> dim: <span class="number">3</span> dim: <span class="number">227</span> dim: <span class="number">227</span> &#125; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>s7，使用caffe2ncnn工具将caffe model转成ncnn model</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./caffe2ncnn deploy.prototxt bvlc_alexnet.caffemodel alexnet.param alexnet.bin</span><br></pre></td></tr></table></figure>
<p>在ncnn/build/tools目录下生成param和bin文件。</p>
<p>s8，对模型参数进行加密</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ncnn2mem alexnet.param alexnet.bin alexnet.id.h alexnet.mem.h</span><br></pre></td></tr></table></figure>
<p>在ncnn/build/tools目录下生成.param、.bin和.h文件。</p>
<p>alexnet.param    网络的模型参数</p>
<p>alexnet.bin   网络的权重</p>
<p>alexnet.id.h   在预测图片的时候使用到</p>
<p>s9，开发安卓项目</p>
<p>(1)在Android Studio上创建一个NCNN1，并选择Include C++ support</p>
<p><img src="https://img-blog.csdn.net/20180905204155999?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMzMjAwOTY3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" /></p>
<p>(2)在main目录下创建assets目录，并将alexnet.param、alexnet.bin、label.txt拷贝其中</p>
<p>(3)将include文件夹和 alexnet.id.h拷贝到cpp目录下</p>
<p>(4)在main目录下创建jniLibs/armeabi-v7a/目录，并将alexnet.id.h 拷贝其中</p>
<p>(5)在cpp文件夹下创建C++文件，用于加载模型和预测图片</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/bitmap.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="comment">// ncnn</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;include/net.h&quot;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;alexnet.id.h&quot;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt; </span></span></span><br><span class="line"><span class="keyword">static</span> ncnn::UnlockedPoolAllocator g_blob_pool_allocator; </span><br><span class="line"><span class="keyword">static</span> ncnn::PoolAllocator g_workspace_pool_allocator; </span><br><span class="line"><span class="keyword">static</span> ncnn::Mat ncnn_param; </span><br><span class="line"><span class="keyword">static</span> ncnn::Mat ncnn_bin; </span><br><span class="line"><span class="keyword">static</span> ncnn::Net ncnn_net; </span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123; </span><br><span class="line"><span class="comment">// public native boolean Init(byte[] param, byte[] bin, byte[] words); JNIEXPORT jboolean JNICALL </span></span><br><span class="line">Java_com_example_ncnn1_NcnnJni_Init(JNIEnv *env, jobject thiz, jbyteArray param, jbyteArray bin) &#123; </span><br><span class="line">	<span class="comment">// init param </span></span><br><span class="line">	&#123; </span><br><span class="line">		<span class="keyword">int</span> len = env-&gt;GetArrayLength(param); </span><br><span class="line">		ncnn_param.create(len, (<span class="keyword">size_t</span>) <span class="number">1u</span>); </span><br><span class="line">		env-&gt;GetByteArrayRegion(param, <span class="number">0</span>, len, (jbyte *) ncnn_param); <span class="keyword">int</span> ret = ncnn_net.load_param((<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) ncnn_param); </span><br><span class="line">		__android_log_print(ANDROID_LOG_DEBUG, <span class="string">&quot;NcnnJni&quot;</span>, <span class="string">&quot;load_param %d %d&quot;</span>, ret, len); </span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">// init bin </span></span><br><span class="line">	&#123; </span><br><span class="line">		<span class="keyword">int</span> len = env-&gt;GetArrayLength(bin); </span><br><span class="line">		ncnn_bin.create(len, (<span class="keyword">size_t</span>) <span class="number">1u</span>); </span><br><span class="line">		env-&gt;GetByteArrayRegion(bin, <span class="number">0</span>, len, (jbyte *) ncnn_bin); </span><br><span class="line">		<span class="keyword">int</span> ret = ncnn_net.load_model((<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) ncnn_bin); </span><br><span class="line">		__android_log_print(ANDROID_LOG_DEBUG, <span class="string">&quot;NcnnJni&quot;</span>, <span class="string">&quot;load_model %d %d&quot;</span>, ret, len); </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	ncnn::Option opt; </span><br><span class="line">	opt.lightmode = <span class="literal">true</span>; </span><br><span class="line">	opt.num_threads = <span class="number">4</span>; </span><br><span class="line">	opt.blob_allocator = &amp;g_blob_pool_allocator; </span><br><span class="line">	opt.workspace_allocator = &amp;g_workspace_pool_allocator; </span><br><span class="line"></span><br><span class="line">	ncnn::set_default_option(opt); </span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> JNI_TRUE; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// public native String Detect(Bitmap bitmap); </span></span><br><span class="line"><span class="function">JNIEXPORT jfloatArray JNICALL <span class="title">Java_com_example_ncnn1_NcnnJni_Detect</span><span class="params">(JNIEnv* env, jobject thiz, jobject bitmap)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">	<span class="comment">// ncnn from bitmap </span></span><br><span class="line">	ncnn::Mat in; </span><br><span class="line">	&#123; </span><br><span class="line">		AndroidBitmapInfo info; </span><br><span class="line">		AndroidBitmap_getInfo(env, bitmap, &amp;info); </span><br><span class="line">		<span class="keyword">int</span> width = info.width; <span class="keyword">int</span> height = info.height; </span><br><span class="line">		<span class="keyword">if</span> (info.format != ANDROID_BITMAP_FORMAT_RGBA_8888) </span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>; </span><br><span class="line"></span><br><span class="line">		<span class="keyword">void</span>* indata; </span><br><span class="line">		AndroidBitmap_lockPixels(env, bitmap, &amp;indata); </span><br><span class="line">		<span class="comment">// 把像素转换成data，并指定通道顺序 </span></span><br><span class="line">		in = ncnn::Mat::from_pixels((<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>*)indata, ncnn::Mat::PIXEL_RGBA2BGR, width, height); </span><br><span class="line">		AndroidBitmap_unlockPixels(env, bitmap); </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="comment">// ncnn_net </span></span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">float</span>&gt; cls_scores; </span><br><span class="line">	&#123; </span><br><span class="line">		<span class="comment">// 减去均值和乘上比例 </span></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">float</span> mean_vals[<span class="number">3</span>] = &#123;<span class="number">103.94f</span>, <span class="number">116.78f</span>, <span class="number">123.68f</span>&#125;; </span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">float</span> scale[<span class="number">3</span>] = &#123;<span class="number">0.017f</span>, <span class="number">0.017f</span>, <span class="number">0.017f</span>&#125;; </span><br><span class="line"></span><br><span class="line">		in.substract_mean_normalize(mean_vals, scale); </span><br><span class="line"></span><br><span class="line">		ncnn::Extractor ex = ncnn_net.create_extractor(); </span><br><span class="line">		<span class="comment">// 如果时不加密是使用ex.input(&quot;data&quot;, in); </span></span><br><span class="line">		ex.input(mobilenet_v2_param_id::BLOB_data, in); </span><br><span class="line"></span><br><span class="line">		ncnn::Mat out; </span><br><span class="line">		<span class="comment">// 如果时不加密是使用ex.extract(&quot;prob&quot;, out); </span></span><br><span class="line">		ex.extract(mobilenet_v2_param_id::BLOB_prob, out); </span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> output_size = out.w; </span><br><span class="line">		jfloat *output[output_size]; </span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; out.w; j++) &#123; </span><br><span class="line">			output[j] = &amp;out[j]; </span><br><span class="line">		&#125; </span><br><span class="line"></span><br><span class="line">		jfloatArray jOutputData = env-&gt;NewFloatArray(output_size); </span><br><span class="line">		<span class="keyword">if</span> (jOutputData == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="literal">nullptr</span>; </span><br><span class="line"></span><br><span class="line">		env-&gt;SetFloatArrayRegion(jOutputData, <span class="number">0</span>, output_size, <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> jfloat *&gt;(*output)); <span class="comment">// copy </span></span><br><span class="line">		<span class="keyword">return</span> jOutputData; </span><br><span class="line">	&#125; </span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(6)在项目包com.example.ncnn1下，修改MainActivity.java中的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.ncnn1; </span><br><span class="line"><span class="keyword">import</span> android.Manifest; </span><br><span class="line"><span class="keyword">import</span> android.app.Activity; </span><br><span class="line"><span class="keyword">import</span> android.content.Intent; </span><br><span class="line"><span class="keyword">import</span> android.content.pm.PackageManager; </span><br><span class="line"><span class="keyword">import</span> android.content.res.AssetManager; </span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap; </span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory; </span><br><span class="line"><span class="keyword">import</span> android.net.Uri; </span><br><span class="line"><span class="keyword">import</span> android.os.Bundle; </span><br><span class="line"><span class="keyword">import</span> android.support.annotation.NonNull; </span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable; </span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.ActivityCompat; </span><br><span class="line"><span class="keyword">import</span> android.support.v4.content.ContextCompat; </span><br><span class="line"><span class="keyword">import</span> android.text.method.ScrollingMovementMethod; </span><br><span class="line"><span class="keyword">import</span> android.util.Log; </span><br><span class="line"><span class="keyword">import</span> android.view.View; </span><br><span class="line"><span class="keyword">import</span> android.widget.Button; </span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView; </span><br><span class="line"><span class="keyword">import</span> android.widget.TextView; </span><br><span class="line"><span class="keyword">import</span> android.widget.Toast; </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.bumptech.glide.Glide; </span><br><span class="line"><span class="keyword">import</span> com.bumptech.glide.load.engine.DiskCacheStrategy; </span><br><span class="line"><span class="keyword">import</span> com.bumptech.glide.request.RequestOptions; </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader; </span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException; </span><br><span class="line"><span class="keyword">import</span> java.io.IOException; </span><br><span class="line"><span class="keyword">import</span> java.io.InputStream; </span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader; </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList; </span><br><span class="line"><span class="keyword">import</span> java.util.Arrays; </span><br><span class="line"><span class="keyword">import</span> java.util.List; </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123; </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = MainActivity.class.getName(); </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> USE_PHOTO = <span class="number">1001</span>; </span><br><span class="line">	<span class="keyword">private</span> String camera_image_path; </span><br><span class="line">	<span class="keyword">private</span> ImageView show_image; </span><br><span class="line">	<span class="keyword">private</span> TextView result_text; </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> load_result = <span class="keyword">false</span>; <span class="keyword">private</span> <span class="keyword">int</span>[] ddims = &#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">224</span>, <span class="number">224</span>&#125;; </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> model_index = <span class="number">1</span>; </span><br><span class="line">	<span class="keyword">private</span> List&lt;String&gt; resultLabel = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">	<span class="keyword">private</span> NcnnJni squeezencnn = <span class="keyword">new</span> NcnnJni();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123; </span><br><span class="line">		<span class="keyword">super</span>.onCreate(savedInstanceState); </span><br><span class="line">		setContentView(R.layout.activity_main); </span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123; </span><br><span class="line">			initSqueezeNcnn(); </span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123; </span><br><span class="line">			Log.e(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;initSqueezeNcnn error&quot;</span>); </span><br><span class="line">		&#125; </span><br><span class="line"></span><br><span class="line">		init_view(); </span><br><span class="line">		readCacheLabelFromLocalFile(); </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initSqueezeNcnn</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123; </span><br><span class="line">		<span class="keyword">byte</span>[] param = <span class="keyword">null</span>; </span><br><span class="line">		<span class="keyword">byte</span>[] bin = <span class="keyword">null</span>; </span><br><span class="line"></span><br><span class="line">		&#123; </span><br><span class="line">			InputStream assetsInputStream = getAssets().open(<span class="string">&quot;mobilenet_v2.param.bin&quot;</span>); </span><br><span class="line">			<span class="keyword">int</span> available = assetsInputStream.available(); </span><br><span class="line">			param = <span class="keyword">new</span> <span class="keyword">byte</span>[available]; </span><br><span class="line">			<span class="keyword">int</span> byteCode = assetsInputStream.read(param); </span><br><span class="line">			assetsInputStream.close(); </span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		&#123; </span><br><span class="line">			InputStream assetsInputStream = getAssets().open(<span class="string">&quot;mobilenet_v2.bin&quot;</span>); </span><br><span class="line">			<span class="keyword">int</span> available = assetsInputStream.available(); </span><br><span class="line">			bin = <span class="keyword">new</span> <span class="keyword">byte</span>[available]; </span><br><span class="line">			<span class="keyword">int</span> byteCode = assetsInputStream.read(bin); </span><br><span class="line">			assetsInputStream.close(); </span><br><span class="line">		&#125; </span><br><span class="line"></span><br><span class="line">		load_result = squeezencnn.Init(param, bin); </span><br><span class="line">		Log.d(<span class="string">&quot;load model&quot;</span>, <span class="string">&quot;result:&quot;</span> + load_result); </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="comment">// initialize view </span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init_view</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		request_permissions(); </span><br><span class="line">		show_image = (ImageView) findViewById(R.id.show_image); </span><br><span class="line">		result_text = (TextView) findViewById(R.id.result_text);</span><br><span class="line">		result_text.setMovementMethod(ScrollingMovementMethod.getInstance()); </span><br><span class="line">		Button use_photo = (Button) findViewById(R.id.use_photo); </span><br><span class="line"></span><br><span class="line">		<span class="comment">// use photo click </span></span><br><span class="line">		use_photo.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123; </span><br><span class="line">			<span class="meta">@Override</span> </span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123; </span><br><span class="line">				<span class="keyword">if</span> (!load_result) &#123; </span><br><span class="line">					Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">&quot;never load model&quot;</span>, Toast.LENGTH_SHORT).show(); </span><br><span class="line">					<span class="keyword">return</span>; </span><br><span class="line">				&#125; </span><br><span class="line">				PhotoUtil.use_photo(MainActivity.<span class="keyword">this</span>, USE_PHOTO); </span><br><span class="line">			&#125; </span><br><span class="line">		&#125;); </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="comment">// load label&#x27;s name </span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readCacheLabelFromLocalFile</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">try</span> &#123; </span><br><span class="line">			AssetManager assetManager = getApplicationContext().getAssets(); </span><br><span class="line">			BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(assetManager.open(<span class="string">&quot;synset.txt&quot;</span>))); </span><br><span class="line">			String readLine = <span class="keyword">null</span>; </span><br><span class="line">			<span class="keyword">while</span> ((readLine = reader.readLine()) != <span class="keyword">null</span>) &#123; </span><br><span class="line">				resultLabel.add(readLine); </span><br><span class="line">			&#125; </span><br><span class="line">			reader.close(); </span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123; </span><br><span class="line">			Log.e(<span class="string">&quot;labelCache&quot;</span>, <span class="string">&quot;error &quot;</span> + e); </span><br><span class="line">		&#125; </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, <span class="meta">@Nullable</span> Intent data)</span> </span>&#123; </span><br><span class="line">		String image_path; </span><br><span class="line">		RequestOptions options = <span class="keyword">new</span> RequestOptions().skipMemoryCache(<span class="keyword">true</span>).diskCacheStrategy(DiskCacheStrategy.NONE); </span><br><span class="line">		<span class="keyword">if</span> (resultCode == Activity.RESULT_OK) &#123; </span><br><span class="line">			<span class="keyword">switch</span> (requestCode) &#123; </span><br><span class="line">				<span class="keyword">case</span> USE_PHOTO: </span><br><span class="line">					<span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123; </span><br><span class="line">						Log.w(TAG, <span class="string">&quot;user photo data is null&quot;</span>); </span><br><span class="line">						<span class="keyword">return</span>; </span><br><span class="line">					&#125; </span><br><span class="line">					Uri image_uri = data.getData(); </span><br><span class="line">					Glide.with(MainActivity.<span class="keyword">this</span>).load(image_uri).apply(options).into(show_image); </span><br><span class="line">					<span class="comment">// get image path from uri </span></span><br><span class="line">					image_path = PhotoUtil.get_path_from_URI(MainActivity.<span class="keyword">this</span>, image_uri); </span><br><span class="line">					<span class="comment">// predict image </span></span><br><span class="line">					predict_image(image_path);</span><br><span class="line">					<span class="keyword">break</span>; </span><br><span class="line">			&#125; </span><br><span class="line">		&#125; </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="comment">//  predict image </span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">predict_image</span><span class="params">(String image_path)</span> </span>&#123; </span><br><span class="line">		<span class="comment">// picture to float array </span></span><br><span class="line">		Bitmap bmp = PhotoUtil.getScaleBitmap(image_path); </span><br><span class="line">		Bitmap rgba = bmp.copy(Bitmap.Config.ARGB_8888, <span class="keyword">true</span>); </span><br><span class="line"></span><br><span class="line">		<span class="comment">// resize to 227x227 </span></span><br><span class="line">		Bitmap input_bmp = Bitmap.createScaledBitmap(rgba, ddims[<span class="number">2</span>], ddims[<span class="number">3</span>], <span class="keyword">false</span>); </span><br><span class="line">		<span class="keyword">try</span> &#123; </span><br><span class="line">			<span class="comment">// Data format conversion takes too long </span></span><br><span class="line">			<span class="comment">// Log.d(&quot;inputData&quot;, Arrays.toString(inputData)); </span></span><br><span class="line">			<span class="keyword">long</span> start = System.currentTimeMillis(); </span><br><span class="line">			<span class="comment">// get predict result </span></span><br><span class="line">			<span class="keyword">float</span>[] result = squeezencnn.Detect(input_bmp); </span><br><span class="line">			<span class="keyword">long</span> end = System.currentTimeMillis(); </span><br><span class="line">			Log.d(TAG, <span class="string">&quot;origin predict result:&quot;</span> + Arrays.toString(result)); </span><br><span class="line">			<span class="keyword">long</span> time = end - start; Log.d(<span class="string">&quot;result length&quot;</span>, String.valueOf(result.length)); </span><br><span class="line">			<span class="comment">// show predict result and time </span></span><br><span class="line">			<span class="keyword">int</span> r = get_max_result(result); </span><br><span class="line">			String show_text = <span class="string">&quot;result：&quot;</span> + r + <span class="string">&quot;\nname：&quot;</span> + resultLabel.get(r) + <span class="string">&quot;\nprobability：&quot;</span> + result[r] + <span class="string">&quot;\ntime：&quot;</span> + time + <span class="string">&quot;ms&quot;</span>; </span><br><span class="line">			result_text.setText(show_text); </span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123; </span><br><span class="line">			e.printStackTrace(); </span><br><span class="line">		&#125; </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="comment">// get max probability label </span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">get_max_result</span><span class="params">(<span class="keyword">float</span>[] result)</span> </span>&#123; </span><br><span class="line">		<span class="keyword">float</span> probability = result[<span class="number">0</span>]; </span><br><span class="line">		<span class="keyword">int</span> r = <span class="number">0</span>; </span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; result.length; i++) &#123; </span><br><span class="line">			<span class="keyword">if</span> (probability &lt; result[i]) &#123; </span><br><span class="line">				probability = result[i]; </span><br><span class="line">				r = i; </span><br><span class="line">			&#125;</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">return</span> r; </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="comment">// request permissions </span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">request_permissions</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		List&lt;String&gt; permissionList = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">		<span class="keyword">if</span> (ContextCompat.checkSelfPermission(<span class="keyword">this</span>, Manifest.permission.CAMERA) != PackageManager.PERMISSION_GRANTED) &#123; </span><br><span class="line">			permissionList.add(Manifest.permission.CAMERA); </span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (ContextCompat.checkSelfPermission(<span class="keyword">this</span>, Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) &#123; </span><br><span class="line">			permissionList.add(Manifest.permission.WRITE_EXTERNAL_STORAGE); </span><br><span class="line">		&#125; </span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ContextCompat.checkSelfPermission(<span class="keyword">this</span>, Manifest.permission.READ_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) &#123; </span><br><span class="line">			permissionList.add(Manifest.permission.READ_EXTERNAL_STORAGE); </span><br><span class="line">		&#125; </span><br><span class="line"></span><br><span class="line">		<span class="comment">// if list is not empty will request permissions </span></span><br><span class="line">		<span class="keyword">if</span> (!permissionList.isEmpty()) &#123; </span><br><span class="line">			ActivityCompat.requestPermissions(<span class="keyword">this</span>, permissionList.toArray(<span class="keyword">new</span> String[permissionList.size()]), <span class="number">1</span>); </span><br><span class="line">		&#125; </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="meta">@NonNull</span> String[] permissions, <span class="meta">@NonNull</span> <span class="keyword">int</span>[] grantResults)</span> </span>&#123; </span><br><span class="line">		<span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults); </span><br><span class="line">		<span class="keyword">switch</span> (requestCode) &#123; </span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span>: </span><br><span class="line">				<span class="keyword">if</span> (grantResults.length &gt; <span class="number">0</span>) &#123; </span><br><span class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; grantResults.length; i++) &#123; </span><br><span class="line">						<span class="keyword">int</span> grantResult = grantResults[i]; </span><br><span class="line">						<span class="keyword">if</span> (grantResult == PackageManager.PERMISSION_DENIED) &#123; </span><br><span class="line">							String s = permissions[i]; </span><br><span class="line">							Toast.makeText(<span class="keyword">this</span>, s + <span class="string">&quot; permission was denied&quot;</span>, Toast.LENGTH_SHORT).show(); </span><br><span class="line">						&#125; </span><br><span class="line">					&#125; </span><br><span class="line">				&#125; </span><br><span class="line">				<span class="keyword">break</span>; </span><br><span class="line">		&#125; </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(7)在项目的包com.example.ncnn1下，创建一个NcnnJni.java类，用于提供JNI接口，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.ncnn1; </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap; </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NcnnJni</span> </span>&#123; </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">Init</span><span class="params">(<span class="keyword">byte</span>[] param, <span class="keyword">byte</span>[] bin)</span></span>; </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">float</span>[] Detect(Bitmap bitmap); </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> &#123; </span><br><span class="line">		System.loadLibrary(<span class="string">&quot;ncnn_jni&quot;</span>); </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(8)在项目的包com.example.ncnn1下，创建一个PhotoUtil.java类，这个是图片的工具类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.ncnn1; </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity; </span><br><span class="line"><span class="keyword">import</span> android.content.Context; </span><br><span class="line"><span class="keyword">import</span> android.content.Intent; </span><br><span class="line"><span class="keyword">import</span> android.database.Cursor; </span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap; </span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory; </span><br><span class="line"><span class="keyword">import</span> android.net.Uri; </span><br><span class="line"><span class="keyword">import</span> android.provider.MediaStore; </span><br><span class="line"><span class="keyword">import</span> java.nio.FloatBuffer; </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhotoUtil</span> </span>&#123; </span><br><span class="line">	<span class="comment">// get picture in photo </span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">use_photo</span><span class="params">(Activity activity, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">		Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_PICK); </span><br><span class="line">		intent.setType(<span class="string">&quot;image/*&quot;</span>); </span><br><span class="line">		activity.startActivityForResult(intent, requestCode); </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="comment">// get photo from Uri </span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get_path_from_URI</span><span class="params">(Context context, Uri uri)</span> </span>&#123; </span><br><span class="line">		String result; </span><br><span class="line">		Cursor cursor = context.getContentResolver().query(uri, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>); </span><br><span class="line">		<span class="keyword">if</span> (cursor == <span class="keyword">null</span>) &#123; </span><br><span class="line">			result = uri.getPath(); </span><br><span class="line">		&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">			cursor.moveToFirst(); </span><br><span class="line">			<span class="keyword">int</span> idx = cursor.getColumnIndex(MediaStore.Images.ImageColumns.DATA); </span><br><span class="line">			result = cursor.getString(idx); </span><br><span class="line">			cursor.close(); </span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">return</span> result; </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="comment">// compress picture </span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">getScaleBitmap</span><span class="params">(String filePath)</span> </span>&#123; </span><br><span class="line">		BitmapFactory.Options opt = <span class="keyword">new</span> BitmapFactory.Options(); </span><br><span class="line">		opt.inJustDecodeBounds = <span class="keyword">true</span>; </span><br><span class="line">		BitmapFactory.decodeFile(filePath, opt); </span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> bmpWidth = opt.outWidth; </span><br><span class="line">		<span class="keyword">int</span> bmpHeight = opt.outHeight; </span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> maxSize = <span class="number">500</span>; </span><br><span class="line">		</span><br><span class="line">		<span class="comment">// compress picture with inSampleSize </span></span><br><span class="line">		opt.inSampleSize = <span class="number">1</span>; </span><br><span class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123; </span><br><span class="line">			<span class="keyword">if</span> (bmpWidth / opt.inSampleSize &lt; maxSize || bmpHeight / opt.inSampleSize &lt; maxSize) &#123; </span><br><span class="line">				<span class="keyword">break</span>; </span><br><span class="line">			&#125; </span><br><span class="line">			opt.inSampleSize *= <span class="number">2</span>; </span><br><span class="line">		&#125; </span><br><span class="line">		opt.inJustDecodeBounds = <span class="keyword">false</span>; </span><br><span class="line">		<span class="keyword">return</span> BitmapFactory.decodeFile(filePath, opt); </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(9)修改启动页面的布局，修改如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span> </span><br><span class="line"></span><br><span class="line">    &lt;LinearLayout</span><br><span class="line">        android:id=&quot;@+id/btn_ll&quot;</span><br><span class="line">        android:layout_alignParentBottom=&quot;true&quot;</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:orientation=&quot;horizontal&quot;&gt; </span><br><span class="line"></span><br><span class="line">        &lt;Button</span><br><span class="line">            android:id=&quot;@+id/use_photo&quot;</span><br><span class="line">            android:layout_weight=&quot;1&quot;</span><br><span class="line">            android:layout_width=&quot;0dp&quot;</span><br><span class="line">            android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">            android:text=&quot;相册&quot; /&gt; </span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span> </span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">    	android:layout_above=&quot;@id/btn_ll&quot;</span><br><span class="line">    	android:id=&quot;@+id/result_text&quot;</span><br><span class="line">    	android:textSize=&quot;16sp&quot;</span><br><span class="line">    	android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    	android:hint=&quot;预测结果会在这里显示&quot;</span><br><span class="line">    	android:layout_height=&quot;100dp&quot; /&gt; </span><br><span class="line">    &lt;ImageView</span><br><span class="line">    	android:layout_alignParentTop=&quot;true&quot;</span><br><span class="line">    	android:layout_above=&quot;@id/result_text&quot;</span><br><span class="line">    	android:id=&quot;@+id/show_image&quot;</span><br><span class="line">    	android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    	android:layout_height=&quot;match_parent&quot; /&gt; </span><br><span class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>(10)修改APP目录下的CMakeLists.txt文件，修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># For more information about using CMake with Android Studio, read the </span><br><span class="line"># documentation: https:&#x2F;&#x2F;d.android.com&#x2F;studio&#x2F;projects&#x2F;add-native-code.html </span><br><span class="line"></span><br><span class="line"># Sets the minimum version of CMake required to build the native library. </span><br><span class="line"></span><br><span class="line">cmake_minimum_required(VERSION 3.4.1) </span><br><span class="line"></span><br><span class="line"># Creates and names a library, sets it as either STATIC </span><br><span class="line"># or SHARED, and provides the relative paths to its source code. </span><br><span class="line"># You can define multiple libraries, and CMake builds them for you. </span><br><span class="line"># Gradle automatically packages shared libraries with your APK. </span><br><span class="line">set(ncnn_lib $&#123;CMAKE_SOURCE_DIR&#125;&#x2F;src&#x2F;main&#x2F;jniLibs&#x2F;armeabi-v7a&#x2F;libncnn.a) </span><br><span class="line">add_library (ncnn_lib STATIC IMPORTED) </span><br><span class="line">set_target_properties(ncnn_lib PROPERTIES IMPORTED_LOCATION $&#123;ncnn_lib&#125;) </span><br><span class="line"></span><br><span class="line">add_library( # Sets the name of the library. </span><br><span class="line">			ncnn_jni </span><br><span class="line">			# Sets the library as a shared library. </span><br><span class="line">			SHARED </span><br><span class="line">			</span><br><span class="line">			# Provides a relative path to your source file(s). </span><br><span class="line">			src&#x2F;main&#x2F;cpp&#x2F;ncnn_jni.cpp ) </span><br><span class="line"></span><br><span class="line"># Searches for a specified prebuilt library and stores the path as a </span><br><span class="line"># variable. Because CMake includes system libraries in the search path by </span><br><span class="line"># default, you only need to specify the name of the public NDK library </span><br><span class="line"># you want to add. CMake verifies that the library exists before </span><br><span class="line"># completing its build. </span><br><span class="line"></span><br><span class="line">find_library( # Sets the name of the path variable. </span><br><span class="line">				log-lib </span><br><span class="line">				</span><br><span class="line">				# Specifies the name of the NDK library that </span><br><span class="line">				# you want CMake to locate. </span><br><span class="line">				log ) </span><br><span class="line"></span><br><span class="line"># Specifies libraries CMake should link to your target library. You </span><br><span class="line"># can link multiple libraries, such as libraries you define in this </span><br><span class="line"># build script, prebuilt third-party libraries, or system libraries. </span><br><span class="line"></span><br><span class="line">target_link_libraries( # Specifies the target library. </span><br><span class="line">						ncnn_jni </span><br><span class="line">						ncnn_lib </span><br><span class="line">						jnigraphics </span><br><span class="line"></span><br><span class="line">						# Links the target library to the log library </span><br><span class="line">						# included in the NDK. </span><br><span class="line">						$&#123;log-lib&#125; )</span><br></pre></td></tr></table></figure>
<p>(11)修改APP目录下的build.gradle文件，修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &#39;com.android.application&#39; </span><br><span class="line"></span><br><span class="line">android &#123; </span><br><span class="line">	compileSdkVersion 28 </span><br><span class="line">	defaultConfig &#123; </span><br><span class="line">		applicationId &quot;com.example.ncnn1&quot; </span><br><span class="line">		minSdkVersion 21 </span><br><span class="line">		targetSdkVersion 28 </span><br><span class="line">		versionCode 1 </span><br><span class="line">		versionName &quot;1.0&quot; </span><br><span class="line">		testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot; </span><br><span class="line">		externalNativeBuild &#123; </span><br><span class="line">			cmake &#123; </span><br><span class="line">				cppFlags &quot;-std&#x3D;c++11 -fopenmp&quot; </span><br><span class="line">				abiFilters &quot;armeabi-v7a&quot; </span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	buildTypes &#123; </span><br><span class="line">		release &#123; </span><br><span class="line">			minifyEnabled false </span><br><span class="line">			proguardFiles getDefaultProguardFile(&#39;proguard-android.txt&#39;), &#39;proguard-rules.pro&#39; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	externalNativeBuild &#123; </span><br><span class="line">		cmake &#123; </span><br><span class="line">			path &quot;CMakeLists.txt&quot; </span><br><span class="line">		&#125; </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	sourceSets &#123; </span><br><span class="line">		main &#123; </span><br><span class="line">			jniLibs.srcDirs &#x3D; [&quot;src&#x2F;main&#x2F;jniLibs&quot;] </span><br><span class="line">			jni.srcDirs &#x3D; [&#39;src&#x2F;cpp&#39;] </span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">dependencies &#123; </span><br><span class="line">	implementation fileTree(dir: &#39;libs&#39;, include: [&#39;*.jar&#39;]) </span><br><span class="line">	implementation &#39;com.android.support:appcompat-v7:28.0.0-rc02&#39; </span><br><span class="line">	implementation &#39;com.android.support.constraint:constraint-layout:1.1.3&#39; </span><br><span class="line">	testImplementation &#39;junit:junit:4.12&#39; </span><br><span class="line">	implementation &#39;com.github.bumptech.glide:glide:4.3.1&#39; </span><br><span class="line">	androidTestImplementation &#39;com.android.support.test:runner:1.0.2&#39; </span><br><span class="line">	androidTestImplementation &#39;com.android.support.test.espresso:espresso-core:3.0.2&#39; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(12)最后在配置文件中添加权限</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span>/&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>(13)编译完成</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Weifeng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://weifeng-chen.github.io/2020/12/02/17.8.1%20NCNN%E9%83%A8%E7%BD%B2/">http://weifeng-chen.github.io/2020/12/02/17.8.1%20NCNN%E9%83%A8%E7%BD%B2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://weifeng-chen.github.io" target="_blank">伟峰的个人网站</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0500%E9%97%AE/">深度学习500问</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="wechat,weibo"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/02/%E7%AC%AC%E5%8D%81%E5%85%AD%E7%AB%A0_NLP/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">第十六章_NLP</div></div></a></div><div class="next-post pull-right"><a href="/2020/12/02/%E7%AC%AC%E5%8D%81%E5%85%AB%E7%AB%A0_%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84%E9%80%89%E5%9E%8B%E3%80%81%E7%A6%BB%E7%BA%BF%E5%8F%8A%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">第十八章_后端架构选型、离线及实时计算</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/12/02/第一章_数学基础/" title="第一章_数学基础"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-02</div><div class="title">第一章_数学基础</div></div></a></div><div><a href="/2020/12/02/第十五章_异构运算、GPU及框架选型/" title="第十五章_异构运算、GPU及框架选型"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-02</div><div class="title">第十五章_异构运算、GPU及框架选型</div></div></a></div><div><a href="/2020/12/02/第十六章_NLP/" title="第十六章_NLP"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-02</div><div class="title">第十六章_NLP</div></div></a></div><div><a href="/2020/12/02/第十章_强化学习/" title="第十章_强化学习"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-02</div><div class="title">第十章_强化学习</div></div></a></div><div><a href="/2020/12/02/第四章_经典网络/" title="第四章_经典网络"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-02</div><div class="title">第四章_经典网络</div></div></a></div><div><a href="/2020/12/02/第五章_卷积神经网络(CNN)/" title="第五章_卷积神经网络(CNN)"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-02</div><div class="title">第五章_卷积神经网络(CNN)</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/myavatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Weifeng</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">22</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Weifeng-Chen"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E5%9C%A8%E7%94%B5%E8%84%91%E7%AB%AF%E4%BD%BF%E7%94%A8ncnn%E5%AE%9E%E7%8E%B0%E5%88%86%E7%B1%BBalexnet"><span class="toc-number">1.</span> <span class="toc-text"> 1.在电脑端使用ncnn实现分类(alexnet)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-win-x64-visual-studio-community-2017"><span class="toc-number">2.</span> <span class="toc-text"> 2. Win x64 (Visual Studio Community 2017)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-android%E7%AB%AF%E4%BD%BF%E7%94%A8ncnn"><span class="toc-number">3.</span> <span class="toc-text"> 3. Android端使用ncnn</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2020/12/02/%E7%AC%AC%E5%8D%81%E4%B9%9D%E7%AB%A0_%E8%BD%AF%E4%BB%B6%E4%B8%93%E5%88%A9%E7%94%B3%E8%AF%B7%E5%8F%8A%E6%9D%83%E5%88%A9%E4%BF%9D%E6%8A%A4/" title="第十九章_软件专利申请及权利保护">第十九章_软件专利申请及权利保护</a><time datetime="2020-12-01T18:28:43.210Z" title="发表于 2020-12-02 02:28:43">2020-12-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2020/12/02/%E7%AC%AC%E5%8D%81%E5%85%AB%E7%AB%A0_%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84%E9%80%89%E5%9E%8B%E5%8F%8A%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/" title="第十八章_后端架构选型及应用场景">第十八章_后端架构选型及应用场景</a><time datetime="2020-12-01T18:28:43.207Z" title="发表于 2020-12-02 02:28:43">2020-12-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2020/12/02/%E7%AC%AC%E5%8D%81%E4%B8%83%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E3%80%81%E5%8A%A0%E9%80%9F%E5%8F%8A%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%83%A8%E7%BD%B2/" title="第十七章_模型压缩、加速及移动端部署">第十七章_模型压缩、加速及移动端部署</a><time datetime="2020-12-01T18:28:42.939Z" title="发表于 2020-12-02 02:28:42">2020-12-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2020/12/02/%E7%AC%AC%E5%8D%81%E5%85%AB%E7%AB%A0_%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84%E9%80%89%E5%9E%8B%E3%80%81%E7%A6%BB%E7%BA%BF%E5%8F%8A%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97/" title="第十八章_后端架构选型、离线及实时计算">第十八章_后端架构选型、离线及实时计算</a><time datetime="2020-12-01T18:28:42.936Z" title="发表于 2020-12-02 02:28:42">2020-12-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2020/12/02/17.8.1%20NCNN%E9%83%A8%E7%BD%B2/" title="17.8.1 NCNN部署">17.8.1 NCNN部署</a><time datetime="2020-12-01T18:28:42.633Z" title="发表于 2020-12-02 02:28:42">2020-12-02</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 By Weifeng</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script>$(function () {
  $('span.katex-display').wrap('<div class="katex-wrap"></div>')
})</script><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'QFyt1EyltV9wQ79929rCl0cF-gzGzoHsz',
      appKey: 'HPLJ5wTMTMHOwnKO08UTETOl',
      placeholder: 'Send me the message!',
      avatar: 'hide',
      meta: 'nick,mail'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '//i0.hdslb.com/bfs/emote/',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign({}, initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><div class="aplayer no-destroy" data-id="106440302" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="true" muted></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config_change',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  $('script[data-pjax]').each(function () {
    $(this).parent().append($(this).remove())
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  if (typeof gtag === 'function') {
    gtag('config', '', {'page_path': window.location.pathname});
  }

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  $(window).off('scroll')

  //reset readmode
  $('body').hasClass('read-mode') && $('body').removeClass('read-mode')

})</script></div></body></html>